<!DOCTYPE html>
<html>

    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Radar Scan</title>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="shortcut icon" href="#"/>
    </head>

    <body>
        <h1> 雷 达 扫 描</h1>
        <div class="slider-container">
            <label for="speedControl">扫描速度：</label>
            <input type="range" class="slider" id="speedControl" min="1" max="10" value="3">
        </div>
        <div class="radar">
            <div class="direction direction-left">0°</div>
            <div class="direction direction-top">90°</div>
            <div class="direction direction-right">180°</div>
        </div>
        <div class="current-time" id="currentTime"></div>
        <div class="scan-range" id="scanRange"></div>
        <div class="target" id="target"></div>
        <table>
            <tr>
                <th>目标距离</th>
                <th>目标角度</th>
            </tr>
            <tbody id="distanceAndAngleTableBody"></tbody>
        </table>
        <div style="position: fixed; bottom: 2px; height: 35%; width: 100%; z-index: 9999;">
            <canvas id="lineChart" width=0></canvas>
        </div>

        <canvas class="scanLineCanvas" id="scanLineCanvas"></canvas>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            setInterval(function() {
                displayTime();
                displayScanRange();
            }, 1000);
            function displayTime() {
                var date = new Date();
                var dateText = document.getElementById('currentTime');
                dateText.innerHTML =  "当前时间: " + date.toLocaleDateString() + " " + date.toLocaleTimeString();
            }
            function displayScanRange() {
                var ScanRange = document.getElementById('scanRange');
                ScanRange.innerHTML = "扫描半径: " + "4000" + " mm";
            }
            
            function displayTarget(distance, angle) {

                var radar = document.querySelector('.radar');
                var radarRect = radar.getBoundingClientRect();
                
                var radarCenterX = (radarRect.left + radarRect.width / 2).toFixed(1);
                var radarCenterY = (radarRect.top + radarRect.height / 2).toFixed(1);

                var radius = distance / 4000 * (radarRect.width / 2);

                var targetX = Number(radarCenterX) - Number(radius * Math.cos(angle * Math.PI / 180));
                var targetY = Number(radarCenterY) - Number(radius * Math.sin(angle * Math.PI / 180));
            
                var target = document.getElementById('target');

                target.style.left = (targetX - 4) + 'px';
                target.style.top = (targetY - 5) + 'px';

                target.style.display = 'block';
                
            }
            function displayDistanceAndAngle(distance, angle) {
                var tableBody = document.getElementById('distanceAndAngleTableBody');
                
                if (tableBody.rows.length >= 20) {
                    tableBody.deleteRow(0);
                }
                
                var newRow = tableBody.insertRow();
                var distanceCell = newRow.insertCell(0);
                var angleCell = newRow.insertCell(1);
                
                if (distance === 0 && angle === 0) {
                    distanceCell.innerHTML = '<span style="color: red;">' + distance + '</span>';
                    angleCell.innerHTML = '<span style="color: red;">' + angle + '</span>';
                } else {
                    distanceCell.innerHTML = distance;
                    angleCell.innerHTML = angle;
                }
            }

            // 绘制扫描线
            const scanLineCanvas = document.getElementById('scanLineCanvas');
            const scanLineCtx = scanLineCanvas.getContext('2d');

            // 设置画布的大小为雷达的大小
            const radar = document.querySelector('.radar');
            const radarRect = radar.getBoundingClientRect();
            // 获取当前页面的宽度和高度
            const pageWidth = document.documentElement.clientWidth;
            const pageHeight = document.documentElement.clientHeight;

            scanLineCanvas.width = pageWidth/2 + radarRect.width/2;
            scanLineCanvas.height = pageHeight/2 + radarRect.height/8;

            // 获取雷达的中心点
            const radarCenterX = radarRect.left + radarRect.width / 2;
            const radarCenterY = radarRect.top + radarRect.height / 2;

            // 定义线段长度
            const lineLength = 330;

            // 绘制线段函数
            function drawScanLine(angle) {
                scanLineCtx.clearRect(0, 0, scanLineCanvas.width, scanLineCanvas.height);
                const endX = radarCenterX - lineLength * Math.cos(angle * Math.PI / 180);
                const endY = radarCenterY - lineLength * Math.sin(angle * Math.PI / 180);
                
                const gradient = scanLineCtx.createLinearGradient(radarCenterX, radarCenterY, endX, endY);
                gradient.addColorStop(0, 'rgba(0, 255, 0, 1)'); // 起始颜色，完全不透明的绿色
                gradient.addColorStop(0.5, 'rgba(0, 255, 0, 0.5)'); // 中间颜色，半透明的绿色
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0)'); // 结束颜色，完全透明的绿色

                scanLineCtx.beginPath();
                scanLineCtx.moveTo(radarCenterX + 1, radarCenterY - 3);
                scanLineCtx.lineTo(endX, endY);
                scanLineCtx.strokeStyle = gradient;
                scanLineCtx.lineWidth = 3;
                scanLineCtx.stroke();
            }

            function generateAngle() {
                let angle = 0;
                let increasing = true;

                return function() {
                    if (increasing) {
                        if (angle < 180) {
                            angle++;
                        } else {
                            increasing = false;
                        }
                    } else {
                        if (angle > 0) {
                            angle--;
                        } else {
                            increasing = true;
                        }
                    }
                    return angle;
                };
            }

            const getNextAngle = generateAngle();
            setInterval(function() {
                const angle = getNextAngle();
                console.log(angle); // 这里可以替换为你需要使用角度的地方
                drawScanLine(angle);
                
            }, 10);

            


            
        </script>
    </body>

</html>