<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Radar Scan</title>
    <link rel="stylesheet" href="/static/css/style.css?v=HASH_VALUE">
    <link rel="shortcut icon" href="#" />
</head>

<body>
    <h1> 雷 达 扫 描</h1>
    <div class="radar">
        <div class="direction direction-left">0°</div>
        <div class="direction direction-top">90°</div>
        <div class="direction direction-right">180°</div>
    </div>
    <div class="targets-container"></div>

    <canvas class="scanLineCanvas" id="scanLineCanvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const targetsContainer = document.querySelector('.targets-container');
        let pointsArray = [];

        function displayTarget(distance, angle) {

            var radar = document.querySelector('.radar');
            var radarRect = radar.getBoundingClientRect();

            var radarCenterX = (radarRect.left + radarRect.width / 2).toFixed(1);
            var radarCenterY = (radarRect.top + radarRect.height / 2).toFixed(1);

            var radius = distance / 4000 * (radarRect.width / 2);

            var targetX = Number(radarCenterX) - Number(radius * Math.cos(angle * Math.PI / 180));
            var targetY = Number(radarCenterY) - Number(radius * Math.sin(angle * Math.PI / 180));

            var target = document.createElement('div');
            target.className = 'target';

            target.style.left = (targetX - 4) + 'px';
            target.style.top = (targetY - 5) + 'px';

            targetsContainer.appendChild(target);
        }

        const ws = new WebSocket("ws://localhost:5000/ws");
        ws.onopen = function (event) {
            console.log("Connected to WebSocket.");
        };

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);

            const distance_forlineChart = data.distance / 4000 * 500;
            const angle_forlineChart = data.angle;

            const distance = data.distance;
            const angle = data.angle;

            if (distance !== 0) {
                if (angle > 0 && angle < 180) {
                    pointsArray.push({ distance, angle });
                    console.log(pointsArray);
                    displayPoints();
                }
                if (angle === 0 || angle === 180) {
                    pointsArray = [];
                    displayPoints();
                }
            }

        };

        function displayPoints() {
            targetsContainer.innerHTML = '';

            pointsArray.forEach(point => {
                displayTarget(point.distance, point.angle);
            });
        }

        ws.onerror = function (error) {
            console.error("WebSocket error: ", error);
        };

        ws.onclose = function (event) {
            if (event.wasClean) {
                console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                console.log('[close] Connection died');
            }
        };


    </script>
</body>

</html>
